# Only subset metadata if there are any NAs
if (any(na_idx)) {
na_samples <- rownames(metadata)[na_idx]
log_warn(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Removing {length(na_samples)} samples with NA in design columns: {paste(na_samples, collapse = ', ')}"))
metadata <- metadata[!na_idx, , drop = FALSE]
}
rownames(metadata)
intersect(colnames(expr_mat), rownames(metadata))
expr_mat[, intersect(colnames(expr_mat), rownames(metadata)), drop = FALSE] %>% dim()
!is.na(rownames(expr_mat))
expr_mat[!is.na(rownames(expr_mat)), ]
is.na(rownames(expr_mat))
expr_mat1 <- expr_mat[!is.na(rownames(expr_mat)), ]
View(expr_mat1)
zero_genes   <- rownames(expr_mat)[which(rowSums(expr_mat) == 0)]
expr_mat1 <- expr_mat[rowSums(expr_mat) != 0, , drop = FALSE]
zero_genes   <- rownames(expr_mat)[which(rowSums(expr_mat[,-1]) == 0)]
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
plot_pca(expr_mat    = raw_counts_df,
metadata    = metadata,
perform_vst = TRUE,
filename    = proj.params$proj,
output_dir  = proj.params$proj_dir)
raw_counts_mat <- read.xlsx(file.path(proj.params$proj_dir, paste0(proj, "_Raw_counts.xlsx"))) %>%
tibble::column_to_rownames("SYMBOL")
# Plot PCA
plot_pca(expr_mat    = raw_counts_mat,
metadata    = metadata,
perform_vst = TRUE,
filename    = proj.params$proj,
output_dir  = proj.params$proj_dir)
remove_samples <- NULL
raw_counts_mat1 <- raw_counts_mat[, !(colnames(raw_counts_mat) %in% remove_samples), drop = FALSE]
all.equal(raw_counts_mat, raw_counts_mat1)
raw_counts_mat <- merge_counts(counts_dir = proj.params$counts_dir,
filename   = proj.params$proj,
output_dir = proj.params$proj_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
raw_counts_mat <- merge_counts(counts_dir = proj.params$counts_dir,
filename   = proj.params$proj,
output_dir = proj.params$proj_dir)
#!/usr/bin/env Rscript
# Read and store variables from command line interface (CLI)
cli <- base::commandArgs(trailingOnly = TRUE)
args <- base::strsplit(x = cli, split = "=", fixed = TRUE)
for (e in args){
argname <- e[1]
argval <- e[2]
assign(argname, argval)
}
# ---- PROJECT SET UP ----
if (.Platform$OS.type == "windows") {
parent_dir  <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data"
gmt_dir     <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Documents/GSEA_genesets"
scripts_dir <- NULL
script_file <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Documents/GitHub/R-Scripts/Custom_Functions.R"
} else {  # Linux/macOS (e.g., HPC)
parent_dir  <- "/hpc/home/kailasamms/scratch"
gmt_dir     <- "/hpc/home/kailasamms/projects/GSEA_genesets"
scripts_dir <- "/hpc/home/kailasamms/projects/scRNASeq"
script_file <- "/hpc/home/kailasamms/projects/scRNASeq/Custom_Functions.R"
}
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
# Define these 4 variables in project specific script
# contrasts <- c()
# deseq2.override <- list()
# heatmap.override <- list()
# volcano.override <- list()
# In this case, the replicates for each group are clustered together.
# So, the within-group variability is low. Hence, we do not subset the data
proj <- "GSE132408"
species <- "Homo sapiens"
contrasts <- c("TET2KO-WT",
"TET2KO.IFNy-WT.IFNy")
# DESeq2 overrides
deseq2.override <- list(
contrasts     = contrasts,
#design        = "Comparisons",            # DESeq2 design formula or column name
#lfc.cutoff    = 0,                        # Log fold change cutoff for significance
#padj.cutoff   = 0.1,                      # Adjusted p-value cutoff for significance
batch.correct = FALSE                     # Boolean, whether to apply batch correction
)
# Heatmap overrides
heatmap.override <- list(
#force.log        = TRUE,                  # Force log transformation
col.ann          = c("Condition", "Treatment"),                  # Column annotation
#row.ann          = NULL,                  # Row annotation
#col.gaps         = NULL,                  # Column gaps
#row.gaps         = NULL,                  # Row gaps
col.cluster      = c("Condition"),                 # Column clustering
#row.cluster      = "all",                 # Row clustering
#palette         = "rdbu",                # Heatmap palette
#ann.palette     = "discrete",            # Annotation palette
#border.color    = NA,                    # Cell border color
#show.expr.legend = TRUE,                  # Show expression legend
#title           = "",                    # Heatmap title
format           = "tiff"                 # Output file format
)
# Volcano plot overrides
volcano.override <- list(
#lfc.cutoff  = 0.58,                         # Minimum log2 fold-change to highlight
#padj.cutoff = 0.05,                      # Adjusted p-value cutoff
#color       = "vrds",                    # Color palette
#label.genes = c()                         # Genes to label on the plot
)
proj.params <- setup_project(proj             = proj,
species          = species,  #"Mus musculus", "Homo sapiens"
contrasts        = contrasts,
parent_dir       = parent_dir,
gmt_dir          = gmt_dir,
scripts_dir      = scripts_dir,
deseq2.override  = deseq2.override,
heatmap.override = heatmap.override,
volcano.override = volcano.override)
# ---- BULK RNA SEQ WORKFLOW ----
# Import metadata
metadata <- read.xlsx(file.path(proj.params$proj_dir, paste0(proj, "_Metadata.xlsx")))
# Compile raw counts if available
raw_counts_mat <- merge_counts(counts_dir = proj.params$counts_dir,
filename   = proj.params$proj,
output_dir = proj.params$proj_dir)
# Import raw counts
raw_counts_mat <- read.xlsx(file.path(proj.params$proj_dir, paste0(proj, "_Raw_counts.xlsx"))) %>%
tibble::column_to_rownames("SYMBOL")
# Plot PCA
plot_pca(expr_mat    = raw_counts_mat,
metadata    = metadata,
perform_vst = TRUE,
filename    = proj.params$proj,
output_dir  = proj.params$proj_dir)
# Remove bad samples based on PCA [CASE by CASE BASIS]
# remove_samples <- c("SBQuadFc2", "SBQuadFc4")
remove_samples <- NULL
raw_counts_mat1 <- raw_counts_mat[, !(colnames(raw_counts_mat) %in% remove_samples), drop = FALSE]
deseq2_data <- prepare_deseq2_input(metadata = metadata,
expr_mat = expr_mat,
design   = proj.params$deseq2$design)
deseq2_data <- prepare_deseq2_input(expr_mat = raw_counts_mat,
metadata = metadata,
design   = proj.params$deseq2$design)
plot_pca(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
top_n_genes = 500,
perform_vst = TRUE,
skip_plot   = FALSE,
filename    = proj.params$proj,
output_dir  = proj.params$proj_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
plot_pca(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
top_n_genes = 500,
perform_vst = TRUE,
skip_plot   = FALSE,
filename    = proj.params$proj,
output_dir  = proj.params$proj_dir)
# Plot PCA
plot_pca(expr_mat    = raw_counts_mat, #deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
top_n_genes = 500,
perform_vst = TRUE,
skip_plot   = FALSE,
filename    = proj.params$proj,
output_dir  = proj.params$proj_dir)
log_error(sample = "",
step   = "prepare_deseq2_input",
msg    = "`metadata` MUST contain 'Sample_ID' column.")
log_error(sample = "",
step   = "prepare_deseq2_input",
msg    = "'metadata' MUST contain 'Sample_ID' column.")
contrasts <- proj.params$deseq2$contrast
contrasts
contrast <- contrasts[1]
contrast
proj.params$deseq2$design
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast)
deseq2_results <- run_deseq2(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
design      = proj.params$deseq2$design,
contrast    = contrast,
output_dir  = output_dir,
lfc.cutoff  = 0,
padj.cutoff = 0.1)
output_dir  <- file.path(proj.params$proj_dir, contrast)
deseq2_results <- run_deseq2(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
design      = proj.params$deseq2$design,
contrast    = contrast,
output_dir  = output_dir,
lfc.cutoff  = 0,
padj.cutoff = 0.1)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast)
deseq2_results <- run_deseq2(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
design      = proj.params$deseq2$design,
contrast    = contrast,
output_dir  = output_dir,
lfc.cutoff  = 0,
padj.cutoff = 0.1)
getAnywhere(df)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast)
deseq2_results <- run_deseq2(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
design      = proj.params$deseq2$design,
contrast    = contrast,
output_dir  = output_dir,
lfc.cutoff  = 0,
padj.cutoff = 0.1)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast)
deseq2_results <- run_deseq2(expr_mat    = deseq2_data$expr_mat,
metadata    = deseq2_data$metadata,
design      = proj.params$deseq2$design,
contrast    = contrast,
output_dir  = output_dir,
lfc.cutoff  = 0,
padj.cutoff = 0.1)
df <- read.xlsx("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/GSE132408_old/TET2KO-WT/DEGs.xlsx")
all.equal(deseq2_results$degs, df)
df1 <- deseq2_results$degs
View(df)
View(df1)
common <- intersect(df1$SYMBOL, df$SYMBOL)
df_sub <- df %>% filter(SYMBOL %in% common
)
df1_sub <- df1 %>% filter(SYMBOL %in% common)
all.equal(df1_sub, df_sub)
all.equal(df1_sub, df_sub, check.attributes =FALSE)
df_extra <- df %>% filter(!(SYMBOL %in% common))
df1_extra <- df1 %>% filter(!(SYMBOL %in% common))
View(df_extra)
View(df1_extra)
dim(df1_extra)
dim(df_extra)
df <- read.xlsx("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/GSE132408_old/TET2KO-WT/VST_counts.xlsx")
df1 <- deseq2_results$vst
View(df1)
View(df)
df1 <- df1 %>% tibble::rownames_to_column("SYMBOL")
df1 <- df1 %>% as.data.frame() %>% tibble::rownames_to_column("SYMBOL")
common <- intersect(df1$SYMBOL, df$SYMBOL)
df_extra <- df %>% filter(!(SYMBOL %in% common))
df1_extra <- df1 %>% filter(!(SYMBOL %in% common))
df_sub <- df %>% filter(SYMBOL %in% common)
df1_sub <- df1 %>% filter(SYMBOL %in% common)
all.equal(df1_sub, df_sub, check.attributes =FALSE)
dim(df_extra)
dim(df1_extra)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir  <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
output_dir  <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
# ---- Visualization: Volcano Plot ----
DEGs_df <- deseq2_results$degs
contrast <- proj.params$deseq2$contrasts[n]
output_dir  <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
res_df %>% colnames()
dds <- deseq2_results$dds
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
filename <- NULL
validate_inputs(dds = dds, output_dir = output_dir, filename = filename)
# Prepare the data with "squished" values
res_df <- as.data.frame(DESeq2::results(dds)) %>%
dplyr::mutate(significant = padj < 0.1 & !is.na(padj),
# Create a label column: only name the top 10 genes by p-value
gene_label = ifelse(significant & rank(padj) <= 10, SYMBOL, NA),
# Cap the LFC for plotting purposes
log2FoldChange_capped = dplyr::case_when(log2FoldChange > 5  ~ 5,
log2FoldChange < -5 ~ -5,
TRUE                ~ log2FoldChange),
# Assign shapes: 16 is a solid circle, 17 is a solid triangle
is_outlier = log2FoldChange > 5 | log2FoldChange < -5,
point_shape = ifelse(is_outlier, 17, 16))
common_theme <-  theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) # Red for significance is standard
p <- ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange, color = significant)) +
geom_point(alpha = 0.4, size = 1) +
theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) # Red for significance is standard
# Add ggrepel for smart labeling
geom_text_repel(aes(label = gene_label),
color = "black",
size = 3,
max.overlaps = 20,
box.padding = 0.5) +
coord_cartesian(ylim = c(-5, 5)) +
labs(title = "MA Plot",
subtitle = "Red points indicate FDR < 0.1",
x = "Mean of Normalized Counts",
y = "Log2 Fold Change")
ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange, color = significant)) +
geom_point(alpha = 0.4, size = 1) +
theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) # Red for significance is standard
# Add ggrepel for smart labeling
geom_text_repel(aes(label = gene_label),
color = "black",
size = 3,
max.overlaps = 20,
box.padding = 0.5) +
coord_cartesian(ylim = c(-5, 5)) +
labs(title = "MA Plot",
subtitle = "Red points indicate FDR < 0.1",
x = "Mean of Normalized Counts",
y = "Log2 Fold Change")
ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange, color = significant)) +
geom_point(alpha = 0.4, size = 1) +
theme_classic() +
custom_theme
ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange, color = significant)) +
geom_point(alpha = 0.4, size = 1) +
theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) +
# Add ggrepel for smart labeling
geom_text_repel(aes(label = gene_label),
color = "black",
size = 3,
max.overlaps = 20,
box.padding = 0.5) +
coord_cartesian(ylim = c(-5, 5)) +
labs(title = "MA Plot",
subtitle = "Red points indicate FDR < 0.1",
x = "Mean of Normalized Counts",
y = "Log2 Fold Change")
ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange, color = significant)) +
geom_point(alpha = 0.4, size = 1) +
theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) +
labs(title = "MA Plot",
subtitle = "Red points indicate FDR < 0.1",
x = "Mean of Normalized Counts",
y = "Log2 Fold Change")
ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange_capped, color = significant)) +
geom_point(alpha = 0.4, size = 1, aes(shape = point_shape)) +
scale_shape_identity() + # Tells ggplot to use the actual numeric shape codes
theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) +
coord_cartesian(ylim = c(-5, 5)) +
# Add a horizontal line to show where the "cap" is
geom_hline(yintercept = c(-5, 5), linetype = "dashed", color = "grey80") +
labs(title = "MA Plot (with Capped Fold Changes)",
subtitle = "Red points indicate FDR < 0.1",
x = "Mean of Normalized Counts",
y = "Log2 Fold Change")
ggplot(data = res_df,
mapping = aes(x = baseMean, y = log2FoldChange_capped, color = significant)) +
geom_point(alpha = 0.4, size = 1, aes(shape = point_shape)) +
scale_shape_identity() + # Tells ggplot to use the actual numeric shape codes
theme_classic() +
custom_theme +
theme(legend.position = "none") +
scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
scale_color_manual(values = c("grey70", "firebrick3")) +
coord_cartesian(ylim = c(-5, 5)) +
labs(title = "MA Plot (with Capped Fold Changes)",
subtitle = "Red points indicate FDR < 0.1",
x = "Mean of Normalized Counts",
y = "Log2 Fold Change")
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
if (file.exists(script_file)) {
source(script_file)
} else{
stop(paste("Custom_Functions.R not found at:", script_file))
}
output_dir <- file.path(proj.params$proj_dir, contrast, "DEG_Analysis")
plot_ma(dds        = deseq2_results$dds,
output_dir = output_dir)
