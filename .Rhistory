promoter_hits
i < - 11
i <- 11
S4Vectors::queryHits(promoter_hits) == i
S4Vectors::subjectHits(promoter_hits)[S4Vectors::queryHits(promoter_hits) == i]
# ---- 0️⃣ Setup ----
library(GenomicRanges)
library(rtracklayer)
library(dplyr)
# ---- Input files ----
path <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/biomodal reports"
gtf_file <- file.path(path, "hg19.refGene.gtf")         # RefSeq GTF
peak_files <- c(file.path(path, "prostate1_peaks.narrowPeak"),
file.path(path, "prostate2_peaks.narrowPeak"),
file.path(path, "prostate3_peaks.narrowPeak"),
file.path(path, "prostate4_peaks.narrowPeak"),
file.path(path, "prostate5_peaks.narrowPeak"))
# ---- 1️⃣ Import GTF ----
gtf <- rtracklayer::import(con = gtf_file, format = "gtf")
# ---- 2️⃣ Define regions to match with Biomodal  ----
transcripts <- gtf[GenomicRanges::mcols(gtf)$type == "transcript"]
# GRange object for gene body
gene_body_gr <- transcripts
# GRange object for promoters
promoter_gr <- GenomicRanges::promoters(x = transcripts,
upstream = 1000,
downstream = 0)
# GRange object around TSS
tss_region_gr <- GenomicRanges::promoters(x = transcripts,
upstream = 200,
downstream = 200)
# GRange object at TSS
tss_pos <- dplyr::if_else(condition = as.logical(GenomicRanges::strand(transcripts) == "+"),
true = GenomicRanges::start(transcripts),
false = GenomicRanges::end(transcripts))
tss_gr <- GenomicRanges::GRanges(seqnames = GenomicRanges::seqnames(transcripts),
ranges = IRanges::IRanges(start = tss_pos, end = tss_pos),
strand = GenomicRanges::strand(transcripts),
gene_id = transcripts$gene_id)
# ---- 3️⃣ Annotate peaks for each file ----
annotated_list <- lapply(peak_files, function(peak_file) {
# Read the peak file
peaks <- rtracklayer::import(con = peak_file, format = "narrowPeak")
# Overlaps
promoter_hits   <- GenomicRanges::findOverlaps(query = peaks, subject = promoter_gr)
tss_hits        <- GenomicRanges::findOverlaps(query = peaks, subject = tss_region_gr)
gene_body_hits <- GenomicRanges::findOverlaps(query = peaks, subject = gene_body_gr)
# Build annotation table
peak_df <- data.frame(peak_name     = GenomicRanges::mcols(peaks)$name,
peak_chr      = GenomicRanges::seqnames(peaks),
peak_start    = GenomicRanges::start(peaks),
peak_end      = GenomicRanges::end(peaks),
in_promoter   = GenomicRanges::countOverlaps(query = peaks, subject = promoter_gr) > 0,
in_tss        = GenomicRanges::countOverlaps(query = peaks, subject = tss_region_gr) > 0,
in_gene_body  = GenomicRanges::countOverlaps(query = peaks, subject = gene_body_gr) > 0,
gene_names    = sapply(seq_along(peaks), function(i) {
unique(c(
promoter_gr$gene_name[S4Vectors::subjectHits(promoter_hits)[S4Vectors::queryHits(promoter_hits) == i]],
tss_region_gr$gene_name[subjectHits(tss_hits)[queryHits(tss_hits) == i]],
gene_body_gr$gene_name[subjectHits(gene_body_hits)[queryHits(gene_body_hits) == i]]
))
}))
return(peak_df)
})
annotated_list <- lapply(peak_files, function(peak_file) {
# Read the peak file
peaks <- rtracklayer::import(con = peak_file, format = "narrowPeak")
# Overlaps
promoter_hits   <- GenomicRanges::findOverlaps(query = peaks, subject = promoter_gr)
tss_hits        <- GenomicRanges::findOverlaps(query = peaks, subject = tss_region_gr)
gene_body_hits <- GenomicRanges::findOverlaps(query = peaks, subject = gene_body_gr)
# Build annotation table
peak_df <- data.frame(peak_name     = GenomicRanges::mcols(peaks)$name,
peak_chr      = GenomicRanges::seqnames(peaks),
peak_start    = GenomicRanges::start(peaks),
peak_end      = GenomicRanges::end(peaks),
in_promoter   = GenomicRanges::countOverlaps(query = peaks, subject = promoter_gr) > 0,
in_tss        = GenomicRanges::countOverlaps(query = peaks, subject = tss_region_gr) > 0,
in_gene_body  = GenomicRanges::countOverlaps(query = peaks, subject = gene_body_gr) > 0,
gene_names    = sapply(seq_along(peaks), function(i) {
# 1. Gather all names
all_overlapping_names <- c(
promoter_gr$gene_name[S4Vectors::subjectHits(promoter_hits)[S4Vectors::queryHits(promoter_hits) == i]],
tss_region_gr$gene_name[S4Vectors::subjectHits(tss_hits)[S4Vectors::queryHits(tss_hits) == i]],
gene_body_gr$gene_name[S4Vectors::subjectHits(gene_body_hits)[S4Vectors::queryHits(gene_body_hits) == i]]
)
# 2. Check if the aggregated vector is empty
unique_names <- unique(all_overlapping_names)
# 3. Conditional return: Return aggregated string or "NA"
if (length(unique_names) == 0) {
return("NA")  # <--- Ensures a single string is returned for non-overlapping peaks
} else {
return(paste(unique_names, collapse = ";"))
}
}))
return(peak_df)
})
View(annotated_list)
table(is.na(gtf$gene_name))
promoter_genes <- lapply(annotated_list, function(df) {
df %>%
dplyr::filter(in_promoter & !is.na(gene_names)) %>%
tidyr::separate_longer_delim(cols = gene_names, delim = ";") %>%
dplyr::pull(gene_names) %>%
unique()
})
tss_genes <- lapply(annotated_list, function(df) {
df %>%
dplyr::filter(in_tss & !is.na(gene_names)) %>%
tidyr::separate_longer_delim(cols = gene_names, delim = ";") %>%
dplyr::pull(gene_names) %>%
unique()
})
gene_body_genes <- lapply(annotated_list, function(df) {
df %>%
dplyr::filter(in_gene_body & !is.na(gene_names)) %>%
tidyr::separate_longer_delim(cols = gene_names, delim = ";") %>%
dplyr::pull(gene_names) %>%
unique()
})
# Genes present in ALL 5 samples
common_promoter_genes <- purrr::reduce(.x = promoter_genes, .f = intersect)
common_tss_genes      <- purrr::reduce(.x = tss_genes, .f = intersect)
common_gene_body_genes <- purrr::reduce(.x = gene_body_genes, .f = intersect)
# Create data frames for each region with a column indicating the region
promoter_df   <- data.frame(gene = common_promoter_genes, region = "promoter")
tss_df        <- data.frame(gene = common_tss_genes, region = "TSS")
gene_body_df  <- data.frame(gene = common_gene_body_genes, region = "gene_body")
# Merge all into one data frame
all_genes_df <- bind_rows(promoter_df, tss_df, gene_body_df) %>%
distinct()  # Remove duplicates if a gene is in multiple regions
# Write to Excel
wb <- createWorkbook()
library(openxlsx)
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "Genes_by_region")
writeData(wb, sheet = "Genes_by_region", all_genes_df)
saveWorkbook(wb, "all_genes_by_region.xlsx", overwrite = TRUE)
# ---- 0️⃣ Setup ----
library(GenomicRanges)
library(rtracklayer)
library(dplyr)
library(openxlsx)
# ---- Input files ----
path <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/biomodal reports"
gtf_file <- file.path(path, "hg19.refGene.gtf")         # RefSeq GTF
peak_files <- c(file.path(path, "prostate1_peaks.narrowPeak"),
file.path(path, "prostate2_peaks.narrowPeak"),
file.path(path, "prostate3_peaks.narrowPeak"),
file.path(path, "prostate4_peaks.narrowPeak"),
file.path(path, "prostate5_peaks.narrowPeak"))
# ---- 1️⃣ Import GTF ----
gtf <- rtracklayer::import(con = gtf_file, format = "gtf")
# ---- 2️⃣ Define regions to match with Biomodal  ----
transcripts <- gtf[GenomicRanges::mcols(gtf)$type == "transcript"]
# GRange object for gene body
gene_body_gr <- transcripts
# GRange object for promoters
promoter_gr <- GenomicRanges::promoters(x = transcripts,
upstream = 1000,
downstream = 0)
# GRange object around TSS
tss_region_gr <- GenomicRanges::promoters(x = transcripts,
upstream = 200,
downstream = 200)
# # GRange object at TSS
# tss_pos <- dplyr::if_else(condition = as.logical(GenomicRanges::strand(transcripts) == "+"),
#                           true = GenomicRanges::start(transcripts),
#                           false = GenomicRanges::end(transcripts))
# tss_gr <- GenomicRanges::GRanges(seqnames = GenomicRanges::seqnames(transcripts),
#                                  ranges = IRanges::IRanges(start = tss_pos, end = tss_pos),
#                                  strand = GenomicRanges::strand(transcripts),
#                                  gene_id = transcripts$gene_id)
# ---- 3️⃣ Annotate peaks for each file ----
annotated_list <- lapply(peak_files, function(peak_file) {
# Read the peak file
peaks <- rtracklayer::import(con = peak_file, format = "narrowPeak")
# Overlaps
promoter_hits   <- GenomicRanges::findOverlaps(query = peaks, subject = promoter_gr)
tss_hits        <- GenomicRanges::findOverlaps(query = peaks, subject = tss_region_gr)
gene_body_hits <- GenomicRanges::findOverlaps(query = peaks, subject = gene_body_gr)
# Build annotation table
peak_df <- data.frame(peak_name     = GenomicRanges::mcols(peaks)$name,
peak_chr      = GenomicRanges::seqnames(peaks),
peak_start    = GenomicRanges::start(peaks),
peak_end      = GenomicRanges::end(peaks),
in_promoter   = GenomicRanges::countOverlaps(query = peaks, subject = promoter_gr) > 0,
in_tss        = GenomicRanges::countOverlaps(query = peaks, subject = tss_region_gr) > 0,
in_gene_body  = GenomicRanges::countOverlaps(query = peaks, subject = gene_body_gr) > 0,
gene_names    = sapply(seq_along(peaks), function(i) {
# 1. Gather all names
all_overlapping_names <- c(
promoter_gr$gene_name[S4Vectors::subjectHits(promoter_hits)[S4Vectors::queryHits(promoter_hits) == i]],
tss_region_gr$gene_name[S4Vectors::subjectHits(tss_hits)[S4Vectors::queryHits(tss_hits) == i]],
gene_body_gr$gene_name[S4Vectors::subjectHits(gene_body_hits)[S4Vectors::queryHits(gene_body_hits) == i]]
)
# 2. Check if the aggregated vector is empty
unique_names <- unique(all_overlapping_names)
# 3. Conditional return: Return aggregated string or "NA"
if (length(unique_names) == 0) {
return("NA")  # <--- Ensures a single string is returned for non-overlapping peaks
} else {
return(paste(unique_names, collapse = ";"))
}
}))
return(peak_df)
})
# Helper function to get collapsed gene names for a single Hits object
get_collapsed_genes <- function(hits, subject_gr) {
# We use seq_along(peaks) here, but define peaks inside lapply
sapply(seq_along(peaks), function(i) {
# Extract gene names for the current peak 'i'
unique_names <- unique(subject_gr$gene_name[S4Vectors::subjectHits(hits)[S4Vectors::queryHits(hits) == i]])
# Return "NA" if no names are found, else return semicolon-separated string
if (length(unique_names) == 0) {
return("NA")
} else {
return(paste(unique_names, collapse = ";"))
}
})
}
annotated_list <- lapply(peak_files, function(peak_file) {
# Read the peak file
peaks <- rtracklayer::import(con = peak_file, format = "narrowPeak")
# Overlaps
promoter_hits   <- GenomicRanges::findOverlaps(query = peaks, subject = promoter_gr)
tss_hits        <- GenomicRanges::findOverlaps(query = peaks, subject = tss_region_gr)
gene_body_hits <- GenomicRanges::findOverlaps(query = peaks, subject = gene_body_gr)
# Build annotation table
peak_df <- data.frame(peak_name     = GenomicRanges::mcols(peaks)$name,
peak_chr      = GenomicRanges::seqnames(peaks),
peak_start    = GenomicRanges::start(peaks),
peak_end      = GenomicRanges::end(peaks),
in_promoter   = GenomicRanges::countOverlaps(query = peaks, subject = promoter_gr) > 0,
in_tss        = GenomicRanges::countOverlaps(query = peaks, subject = tss_region_gr) > 0,
in_gene_body  = GenomicRanges::countOverlaps(query = peaks, subject = gene_body_gr) > 0,
promoter_gene_names  = get_collapsed_genes(promoter_hits, promoter_gr),
tss_gene_names       = get_collapsed_genes(tss_hits, tss_region_gr),
gene_body_gene_names = get_collapsed_genes(gene_body_hits, gene_body_gr)
)
return(peak_df)
})
# Helper function to get collapsed gene names for a single Hits object
get_collapsed_genes <- function(peaks, hits, subject_gr) {
# We use seq_along(peaks) here, but define peaks inside lapply
sapply(seq_along(peaks), function(i) {
# Extract gene names for the current peak 'i'
unique_names <- unique(subject_gr$gene_name[S4Vectors::subjectHits(hits)[S4Vectors::queryHits(hits) == i]])
# Return "NA" if no names are found, else return semicolon-separated string
if (length(unique_names) == 0) {
return("NA")
} else {
return(paste(unique_names, collapse = ";"))
}
})
}
annotated_list <- lapply(peak_files, function(peak_file) {
# Read the peak file
peaks <- rtracklayer::import(con = peak_file, format = "narrowPeak")
# Overlaps
promoter_hits   <- GenomicRanges::findOverlaps(query = peaks, subject = promoter_gr)
tss_hits        <- GenomicRanges::findOverlaps(query = peaks, subject = tss_region_gr)
gene_body_hits <- GenomicRanges::findOverlaps(query = peaks, subject = gene_body_gr)
# Build annotation table
peak_df <- data.frame(peak_name     = GenomicRanges::mcols(peaks)$name,
peak_chr      = GenomicRanges::seqnames(peaks),
peak_start    = GenomicRanges::start(peaks),
peak_end      = GenomicRanges::end(peaks),
in_promoter   = GenomicRanges::countOverlaps(query = peaks, subject = promoter_gr) > 0,
in_tss        = GenomicRanges::countOverlaps(query = peaks, subject = tss_region_gr) > 0,
in_gene_body  = GenomicRanges::countOverlaps(query = peaks, subject = gene_body_gr) > 0,
promoter_gene_names  = get_collapsed_genes(peaks, promoter_hits, promoter_gr),
tss_gene_names       = get_collapsed_genes(peaks, tss_hits, tss_region_gr),
gene_body_gene_names = get_collapsed_genes(peaks, gene_body_hits, gene_body_gr)
)
return(peak_df)
})
# Get all gene IDs in promoter/TSS/gene body for each sample
promoter_genes <- lapply(annotated_list, function(df) {
df %>%
dplyr::filter(in_promoter & promoter_gene_names != "NA") %>%
tidyr::separate_longer_delim(cols = promoter_gene_names, delim = ";") %>%
dplyr::pull(promoter_gene_names) %>%
unique()
})
tss_genes <- lapply(annotated_list, function(df) {
df %>%
dplyr::filter(in_tss & tss_gene_names != "NA") %>%
tidyr::separate_longer_delim(cols = tss_gene_names, delim = ";") %>%
dplyr::pull(tss_gene_names) %>%
unique()
})
gene_body_genes <- lapply(annotated_list, function(df) {
df %>%
dplyr::filter(in_gene_body & gene_body_gene_names != "NA") %>%
tidyr::separate_longer_delim(cols = gene_body_gene_names, delim = ";") %>%
dplyr::pull(gene_body_gene_names) %>%
unique()
})
# Genes present in ALL 5 samples
common_promoter_genes <- purrr::reduce(.x = promoter_genes, .f = intersect)
common_tss_genes      <- purrr::reduce(.x = tss_genes, .f = intersect)
common_gene_body_genes <- purrr::reduce(.x = gene_body_genes, .f = intersect)
# ---- 5️⃣ Save results ----
# Create data frames for each region with a column indicating the region
promoter_df   <- data.frame(gene = common_promoter_genes, region = "promoter")
tss_df        <- data.frame(gene = common_tss_genes, region = "TSS")
gene_body_df  <- data.frame(gene = common_gene_body_genes, region = "gene_body")
# Merge all into one data frame
all_genes_df <- bind_rows(promoter_df, tss_df, gene_body_df) %>%
distinct()  # Remove duplicates if a gene is in multiple regions
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "Genes_by_region")
writeData(wb, sheet = "Genes_by_region", all_genes_df)
saveWorkbook(wb, "all_genes_by_region.xlsx", overwrite = TRUE)
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "Genes_by_region")
writeData(wb, sheet = "Genes_by_region", all_genes_df)
saveWorkbook(wb, "all_genes_by_region.xlsx", overwrite = TRUE)
View(annotated_list)
# Read Biomodal results
biomodal_dmr <- read.xlsx(file.path(path, "Biomodal_results.xlsx"))
View(biomodal_dmr)
normal_peaks <- read.xlsx(file.path(path,  "all_genes_by_region.xlsx"))
identical(normal_peaks, all_genes_df)
View(all_genes_df)
gene_body_biomodal <- biomodal_dmr %>% dplyr::filter(Annotation == "Gene")
gene_body_normal <- normal_peaks %>% dplyr::filter(region == "gene_body")
View(gene_body_biomodal)
View(all_genes_df)
gene_body_normal <- normal_peaks %>% dplyr::filter(region == "gene_body") %>% dplyr::pull(gene)
gene_body_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "Gene", !(Name %in% gene_body_normal))
View(gene_body_tumor)
intersect(gene_body_tumor$Name, gene_body_normal)
intersect(biomodal_dmr %>% filter(Annotation == "Gene") %>% pull(Name), gene_body_normal) %>% length()
tss_normal <- normal_peaks %>% dplyr::filter(region == "TSS") %>% dplyr::pull(gene)
tss_normal <- normal_peaks %>% dplyr::filter(region == "TSS") %>% dplyr::pull(gene)
tss_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "Gene", !(Name %in% tss_normal))
View(biomodal_dmr)
intersect(biomodal_dmr %>% filter(Annotation == "TSS") %>% pull(Name), tss_normal) %>% length()
tss_normal <- normal_peaks %>% dplyr::filter(region == "TSS") %>% dplyr::pull(gene)
tss_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "TSS", !(Name %in% tss_normal))
promoter_normal <- normal_peaks %>% dplyr::filter(region == "promoter") %>% dplyr::pull(gene)
promoter_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "Promoter", !(Name %in% promoter_normal))
intersect(biomodal_dmr %>% filter(Annotation == "Promoter") %>% pull(Name), promoter_normal) %>% length()
# Genes present in ALL 5 samples
common_promoter_genes <- purrr::reduce(.x = promoter_genes, .f = intersect)
common_tss_genes      <- purrr::reduce(.x = tss_genes, .f = intersect)
common_gene_body_genes <- purrr::reduce(.x = gene_body_genes, .f = intersect)
# ---- 5️⃣ Save results ----
# Create data frames for each region with a column indicating the region
promoter_df   <- data.frame(gene = common_promoter_genes, region = "Promoter")
tss_df        <- data.frame(gene = common_tss_genes, region = "TSS")
gene_body_df  <- data.frame(gene = common_gene_body_genes, region = "Gene")
# Merge all into one data frame
all_genes_df <- bind_rows(promoter_df, tss_df, gene_body_df) %>%
distinct()  # Remove duplicates if a gene is in multiple regions
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "Genes_by_region")
writeData(wb, sheet = "Genes_by_region", all_genes_df)
saveWorkbook(wb, file.path(path, "all_genes_by_region.xlsx"), overwrite = TRUE)
biomodal_dmr <- read.xlsx(file.path(path, "Biomodal_results.xlsx"))
normal_peaks <- read.xlsx(file.path(path,  "all_genes_by_region.xlsx"))
gene_body_normal <- normal_peaks %>% dplyr::filter(region == "Gene") %>% dplyr::pull(gene)
gene_body_tumor1 <- biomodal_dmr %>% dplyr::filter(Annotation == "Gene", !(Name %in% gene_body_normal))
tss_normal <- normal_peaks %>% dplyr::filter(region == "TSS") %>% dplyr::pull(gene)
tss_tumor1 <- biomodal_dmr %>% dplyr::filter(Annotation == "TSS", !(Name %in% tss_normal))
promoter_normal <- normal_peaks %>% dplyr::filter(region == "Promoter") %>% dplyr::pull(gene)
promoter_tumor1 <- biomodal_dmr %>% dplyr::filter(Annotation == "Promoter", !(Name %in% promoter_normal))
identical(promoter_tumor, promoter_tumor1)
identical(tss_tumor, tss_tumor1)
identical(gene_body_tumor, gene_body_tumor1)
View(normal_peaks)
# Create data frames for each region with a column indicating the region
# Using Name, Annotation, Promoter, TSS, Gene to match biomodal DMR xlsx
promoter_df   <- data.frame(Name = common_promoter_genes, Annotation = "Promoter")
tss_df        <- data.frame(Name = common_tss_genes, Annotation = "TSS")
gene_body_df  <- data.frame(Name = common_gene_body_genes, Annotation = "Gene")
# Merge all into one data frame
all_genes_df <- bind_rows(promoter_df, tss_df, gene_body_df) %>%
distinct()  # Remove duplicates if a gene is in multiple regions
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "Genes_by_region")
writeData(wb, sheet = "Genes_by_region", all_genes_df)
saveWorkbook(wb, file.path(path, "all_genes_by_region.xlsx"), overwrite = TRUE)
biomodal_dmr <- read.xlsx(file.path(path, "Biomodal_results.xlsx"))
normal_peaks <- read.xlsx(file.path(path,  "all_genes_by_region.xlsx"))
biomodal_tumor <- biomodal_dmr %>%
anti_join(normal_peaks, by = c("Name"="Name", "Annotation"="Annotation"))
gene_body_normal <- normal_peaks %>% dplyr::filter(region == "Gene") %>% dplyr::pull(gene)
gene_body_normal <- normal_peaks %>% dplyr::filter(Annotation == "Gene") %>% dplyr::pull(Name)
gene_body_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "Gene", !(Name %in% gene_body_normal))
tss_normal <- normal_peaks %>% dplyr::filter(Annotation == "TSS") %>% dplyr::pull(Name)
tss_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "TSS", !(Name %in% tss_normal))
promoter_normal <- normal_peaks %>% dplyr::filter(Annotation == "Promoter") %>% dplyr::pull(Name)
promoter_tumor <- biomodal_dmr %>% dplyr::filter(Annotation == "Promoter", !(Name %in% promoter_normal))
biomodal_tumor1 <- dplyr::bind_rows(gene_body_tumor, tss_tumor, promoter_tumor)
identical(biomodal_tumor, biomodal_tumor1)
all.equal(biomodal_tumor, biomodal_tumor1)
biomodal_tumor <- biomodal_dmr %>%
anti_join(normal_peaks, by = c("Name"="Name", "Annotation"="Annotation")) %>%
arrange(Annotation, Name)
biomodal_tumor1 <- dplyr::bind_rows(gene_body_tumor, tss_tumor, promoter_tumor) %>% arrange(Annotation, Name)
identical(biomodal_tumor, biomodal_tumor1)
all.equal(biomodal_tumor, biomodal_tumor1)
head(biomodal_tumor)
dmr_summary <- biomodal_tumor %>%
# Filter for significant DMRs
dplyr::filter(dmr_qvalue < 0.05) %>%
# Create a column to categorize the change direction
dplyr::mutate(Direction = dplyr::case_when(mod_difference > 0 ~ "Hyper-modified (Up)",
mod_difference < 0 ~ "Hypo-modified (Down)",
TRUE ~ "No Change")) %>% # Should be rare after filtering
# Count unique genes by Annotation and Direction
dplyr::group_by(Annotation, Direction) %>%
dplyr::summarise(Unique_Genes = n_distinct(Name),
.groups = "drop") %>%
# Pivot wider for a clean summary table format
tidyr::pivot_wider(names_from = Direction,
values_from = Unique_Genes,
values_fill = 0)
# Display the summary table
print(dmr_summary)
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "5hmc_Tumor")
writeData(wb, sheet = "5hmc_Tumor", biomodal_tumor)
saveWorkbook(wb, file.path(path, "Biomodal_tumor.xlsx"), overwrite = TRUE)
biomodal_5mc <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Processed_5mc")
biomodal_5mc <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Processed_5mc")
biomodal_5mc <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Processed_5mc")
comparison_df <- dplyr::inner_join(x = mc_df %>% dplyr::rename(hmc_diff = mod_difference) %>% dplyr::select(Name, Annotation, hmc_diff),
y = hmc_df %>% dplyr::rename(mc_diff = mod_difference) %>% dplyr::select(Name, Annotation, mc_diff),
by = c("Name", "Annotation"))
#  Comparison directionof 5mc and 5hmc
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference) %>% dplyr::select(Name, Annotation, hmc_diff),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference) %>% dplyr::select(Name, Annotation, mc_diff),
by = c("Name", "Annotation"))
# Read Biomodal results
biomodal_5hmc <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Processed_5hmc")
biomodal_5mc <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Processed_5mc")
normal_peaks <- read.xlsx(file.path(path,  "all_genes_by_region.xlsx"))
#  Comparison directionof 5mc and 5hmc
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference) %>% dplyr::select(Name, Annotation, hmc_diff),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference) %>% dplyr::select(Name, Annotation, mc_diff),
by = c("Name", "Annotation"))
View(comparison_df)
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference) %>% dplyr::select(Name, Annotation, hmc_diff),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference) %>% dplyr::select(Name, Annotation, mc_diff),
by = c("Name", "Annotation")) %>%
dplyr::mutate(Trend = dplyr::case_when((mc_diff > 0 & hmc_diff < 0) | (mc_diff < 0 & hmc_diff > 0) ~ "Inverse",
(mc_diff > 0 & hmc_diff > 0) | (mc_diff < 0 & hmc_diff < 0) ~ "Concordant",
TRUE ~ "Unknown"))
comparison_df %>% dplyr::count(Trend)
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference) %>% dplyr::select(Name, Annotation, hmc_diff),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference) %>% dplyr::select(Name, Annotation, mc_diff),
by = c("Name"= "Name", "Annotation"="Annotation")) %>%
dplyr::mutate(Trend = dplyr::case_when((mc_diff > 0 & hmc_diff < 0) | (mc_diff < 0 & hmc_diff > 0) ~ "Inverse",
(mc_diff > 0 & hmc_diff > 0) | (mc_diff < 0 & hmc_diff < 0) ~ "Concordant",
TRUE ~ "Unknown"))
comparison_df %>% dplyr::count(Trend)
biomodal_5hmc_raw <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Raw_5hmc")
biomodal_5hmc_raw <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Original_5hmc")
biomodal_5mc_raw <- read.xlsx(file.path(path, "Biomodal_results.xlsx"), sheet = "Original_5mc")
View(comparison_df)
View(biomodal_5hmc)
#  Comparison directionof 5mc and 5hmc
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference) %>% dplyr::select(Name, Annotation, hmc_diff),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference) %>% dplyr::select(Name, Annotation, mc_diff),
by = c("Name"= "Name", "Annotation"="Annotation")) %>%
dplyr::mutate(Trend = dplyr::case_when((mc_diff > 0 & hmc_diff < 0) | (mc_diff < 0 & hmc_diff > 0) ~ "Inverse",
(mc_diff > 0 & hmc_diff > 0) | (mc_diff < 0 & hmc_diff < 0) ~ "Concordant",
TRUE ~ "Unknown")) %>%
dplyr::arrange(Trend, Annotation, Name)
#  Comparison directionof 5mc and 5hmc
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference, hmc_logFC = mod_fold_change) %>% dplyr::select(Name, Annotation, hmc_diff, hmc_logFC ),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference, mc_logFC = mod_fold_change) %>% dplyr::select(Name, Annotation, mc_diff, mc_logFC ),
by = c("Name"= "Name", "Annotation"="Annotation")) %>%
dplyr::mutate(Trend = dplyr::case_when((mc_diff > 0 & hmc_diff < 0) | (mc_diff < 0 & hmc_diff > 0) ~ "Inverse",
(mc_diff > 0 & hmc_diff > 0) | (mc_diff < 0 & hmc_diff < 0) ~ "Concordant",
TRUE ~ "Unknown")) %>%
dplyr::arrange(Trend, Annotation, Name)
#  Comparison directionof 5mc and 5hmc
comparison_df <- dplyr::inner_join(x = biomodal_5hmc %>% dplyr::rename(hmc_diff = mod_difference, hmc_logFC = mod_fold_change) %>% dplyr::select(Name, Annotation, hmc_diff, hmc_logFC ),
y = biomodal_5mc %>% dplyr::rename(mc_diff = mod_difference, mc_logFC = mod_fold_change) %>% dplyr::select(Name, Annotation, mc_diff, mc_logFC ),
by = c("Name"= "Name", "Annotation"="Annotation")) %>%
dplyr::mutate(Trend = dplyr::case_when((mc_diff > 0 & hmc_diff < 0) | (mc_diff < 0 & hmc_diff > 0) ~ "Inverse",
(mc_diff > 0 & hmc_diff > 0) | (mc_diff < 0 & hmc_diff < 0) ~ "Concordant",
TRUE ~ "Unknown")) %>%
dplyr::arrange(Trend, Annotation, Name) %>%
dplyr::select(Name, Annotation, hmc_diff, mc_diff, hmc_logFC, mc_logFC, Trend)
# Write to Excel
wb <- createWorkbook()
addWorksheet(wb, "5hmc_Tumor")
writeData(wb, sheet = "5hmc_Tumor", biomodal_tumor)
addWorksheet(wb, "5hmc.5mc.Trend")
writeData(wb, sheet = "5hmc.5mc.Trend", comparison_df)
addWorksheet(wb, "5hmc_Processed")
writeData(wb, sheet = "5hmc_Processed", biomodal_5hmc)
addWorksheet(wb, "5mc_Processed")
writeData(wb, sheet = "5mc_Processed", biomodal_5mc)
addWorksheet(wb, "5hmc_Raw")
writeData(wb, sheet = "5hmc_Raw", biomodal_5hmc_raw)
addWorksheet(wb, "5mc_Raw")
writeData(wb, sheet = "5mc_Raw", biomodal_5mc_raw)
saveWorkbook(wb, file.path(path, "Biomodal_tumor.xlsx"), overwrite = TRUE)
View(dmr_summary)
