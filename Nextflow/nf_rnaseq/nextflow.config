// =========================================================================================
// NEXTFLOW CONFIGURATION FILE
// =========================================================================================
// Purpose: Centralized configuration for the RNA-seq analysis pipeline
//
// This file defines:
//   1. Global parameters (paths, reference files, tool arguments)
//   2. Project-specific profiles (for different datasets/species)
//   3. Process execution settings (resources, error handling, output directories)
//   4. Executor configuration (local, SGE, cloud)
//
// Configuration hierarchy:
//   Default params → Profile overrides → Command-line overrides
//   Example: nextflow run main.nf -profile xinyi --raw_fastq_dir /custom/path
//
// =========================================================================================

// =========================================================================================
// CONFIGURATION DESIGN PRINCIPLES
// =========================================================================================
// **CRITICAL RULES - READ CAREFULLY:**
//
// 1. DATA TYPES:
//    - Only define static values here: strings, numbers, booleans, lists, maps
//    - Valid: params.genome = "GRCh38"
//    - Valid: params.cpus = 8
//    - Valid: params.ref_fasta = ["Human": "/path/to/human.fa"]
//
// 2. NO CHANNELS:
//    - DO NOT create channels here using Channel.fromPath() or similar
//    - Why? Configuration is parsed BEFORE the execution engine starts
//    - Channels can only be created in workflow/process blocks in .nf files
//
// 3. CLOSURES FOR DYNAMIC PATHS:
//    - Use closures { } to delay evaluation until runtime
//    - This allows paths to reflect profile-specific values
//    - Example: params.proj_dir = { "${params.base_dir}/${params.project}" }
//    - Call with parentheses: params.proj_dir() returns the evaluated string
//
// 4. COMMAND-LINE OVERRIDES:
//    - Any params value can be overridden: --param_name value
//    - Example: nextflow run main.nf -profile xinyi --base_dir /scratch2
//    - Useful for testing or one-off runs
//
// =========================================================================================

// =========================================================================================
// IMPORTANT SETUP NOTES
// =========================================================================================
// **BEFORE RUNNING THE PIPELINE:**
//
// [1] SET YOUR PROJECT PROFILE:
//     - Edit the "profiles" section below to add your project
//     - Or use an existing profile: -profile xinyi, -profile sandrine, etc.
//
// [2] UPDATE BASE_DIR:
//     - Current: "${System.getenv('HOME')}/scratch/"
//     - Change to your scratch/working directory
//     - Place raw reads in: ${base_dir}/${expt}/${project}/01.FastQ/raw
//     - Example: ~/scratch/RNASeq/Xinyi/01.FastQ/raw/*.fastq.gz
//
// [3] UPDATE REF_DIR:
//     - Current: "${System.getenv('HOME')}/NGSTools/Reference_Genomes/"
//     - Change to where your reference genomes are stored
//     - Expected structure:
//       ${ref_dir}/Human/
//         ├── Homo_sapiens.GRCh38.dna.primary_assembly.fa
//         ├── Homo_sapiens.GRCh38.113.gtf
//         ├── star_index_dir/
//         └── salmon_index_dir/
//       ${ref_dir}/Mouse/
//         ├── Mus_musculus.GRCm39.dna.primary_assembly.fa
//         ├── Mus_musculus.GRCm39.113.gtf
//         ├── star_index_dir/
//         └── salmon_index_dir/
//
// [4] CLEAN UP WORK DIRECTORY:
//     - After successful runs: nextflow clean -f
//     - Removes cached files in work/ directory
//     - Frees up disk space
//
// =========================================================================================

// =========================================================================================
// TRACE, REPORT, AND TIMELINE CONFIGURATION
// =========================================================================================
// These settings control Nextflow's execution reports
// Generated files provide detailed insights into pipeline execution:
//   - trace.txt: Task-level execution details (task_id, status, duration, resources)
//   - report.html: Summary statistics and resource usage charts
//   - timeline.html: Gantt chart visualization of task execution over time

def trace_dir = { "${params.proj_dir()}/07.Logs" }

trace {
    enabled   = true                              // Enable execution trace
    overwrite = true                              // Overwrite existing trace file on each run
    file      = { "${trace_dir}/trace.txt" }      // Output filename
    // Trace contains: task_id, process, status, exit_code, duration, memory, cpus
}

report {
    enabled   = true                              // Enable HTML execution report
    overwrite = true                              // Overwrite existing report
    file      = { "${trace_dir}/report.html" }    // Output filename
    // Report contains: resource usage, task completion times, success/failure stats
}

timeline {
    enabled   = true                              // Enable timeline visualization
    overwrite = true                              // Overwrite existing timeline
    file      = { "${trace_dir}/timeline.html" }  // Output filename
    // Timeline shows: Gantt chart of task execution over time
}

// =========================================================================================
// SINGULARITY CONTAINER CONFIGURATION
// =========================================================================================
// Configures Singularity for containerized process execution
// This ensures reproducibility and consistent software environments across different systems

singularity {
    enabled     = true                            // Enable Singularity container support
    autoMounts  = false                           // Disable automatic bind path detection
    
    // Manual bind mounts - specify exact paths to avoid symlink issues
    // IMPORTANT: Ensure these match your actual file system paths
    // If containers can't find input files, add the missing paths here
    runOptions  = "--bind /scratch --bind /home/kailasamms --bind /hpc/home/kailasamms"
    
    // Cache directory for downloaded container images
    // CRITICAL: Using cacheDir prevents re-downloading containers for every sample
    // This dramatically speeds up pipeline execution and reduces network usage
    cacheDir    = "/home/kailasamms/scratch/singularity_cache"
    
    // TROUBLESHOOTING PATH ISSUES:
    // Use the exact path, not a closure like { "${params.base_dir}/singularity_cache" }
    // 
    // If you encounter "file not found" errors from within containers:
    // 1. Navigate to the work folder mentioned in the error message
    // 2. Run 'ls -lh' to view symbolic links
    // 3. Check if the symlink paths match what's specified in runOptions
    // 4. Add any missing paths to runOptions
    //
    // Example path mismatch scenario:
    // - Singularity sees:  /scratch/kailasamms/RNASeq/Xinyi/01.FastQ/raw/file.fastq.gz
    // - Actual path is:    /hpc/home/kailasamms/scratch/RNASeq/Xinyi/01.FastQ/raw/file.fastq.gz
    // Solution: Add both paths to runOptions (already done above)
    //
    // Example symlink inspection:
    // $ ls -lh ~/scratch/work/3a/517fad7a2216eb95706e660bc3cc68/
    // lrwxrwxrwx ... L1MKI1007710-A2514790_R1.fastq.gz -> /scratch/kailasamms/RNASeq/...
    //
    // $ ls -lh /hpc/home/kailasamms/scratch/RNASeq/Xinyi/01.FastQ/raw/L1MKI1007710*
    // -rw-r--r-- ... /hpc/home/kailasamms/scratch/RNASeq/Xinyi/01.FastQ/raw/L1MKI1007710-A2514790_R1.fastq.gz
    //
    // This is why we turn off autoMounts and give exact paths
}

// =========================================================================================
// GLOBAL PROJECT PARAMETERS
// =========================================================================================
// These are default values that can be overridden by profiles or command-line arguments
// Most parameters use closures { } to allow dynamic evaluation based on profile settings

params {
    // =====================================================================================
    // PROJECT IDENTIFICATION
    // =====================================================================================
    // Default to "test" to force users to select a valid profile
    // The main.nf script will error out if these remain as "test"
    
    project = "test"        // Project name (e.g., "Xinyi", "Manish_22RV1_ARCaPM")
    species = "test"        // Species (e.g., "Human", "Mouse")
    expt    = "RNASeq"      // Experiment type (used in directory structure)
    assay   = "RNA"         // Assay type (required by downstream R scripts)
    
    // genome_version is set by profiles (e.g., "GRCh38", "GRCm39")
    // Used for documentation and logging purposes
    
    // =====================================================================================
    // DIRECTORY STRUCTURE
    // =====================================================================================
    // Base directories for reference genomes and project data
    
    // Reference genome directory
    // Contains FASTA, GTF, and index files for each species
    ref_dir = "${System.getenv('HOME')}/NGSTools/Reference_Genomes"
    
    // Base working directory
    // All project data will be organized under this directory
    base_dir = "${System.getenv('HOME')}/scratch"
    
    // =====================================================================================
    // DYNAMIC PATH CLOSURES
    // =====================================================================================
    // These use closures { } to delay evaluation until runtime
    // This is CRITICAL - allows paths to incorporate profile-specific values
    //
    // Without closures:
    //   params.project = "test"
    //   params.proj_dir = "${params.base_dir}/${params.project}"  // Evaluates to ".../test"
    //   [profile sets params.project = "Xinyi"]
    //   params.proj_dir still equals ".../test" (already evaluated!)
    //
    // With closures:
    //   params.proj_dir = { "${params.base_dir}/${params.project}" }
    //   [profile sets params.project = "Xinyi"]
    //   params.proj_dir() now correctly returns ".../Xinyi"
    
    // Project directory: ${base_dir}/${expt}/${project}
    // Example: ~/scratch/RNASeq/Xinyi
    proj_dir = { "${params.base_dir}/${params.expt}/${params.project}" }
    
    // FASTQ directory: ${proj_dir}/01.FastQ
    // Example: ~/scratch/RNASeq/Xinyi/01.FastQ
    fastq_dir = { "${params.proj_dir()}/01.FastQ" }
    
    // Raw FASTQ directory: ${fastq_dir}/raw
    // Example: ~/scratch/RNASeq/Xinyi/01.FastQ/raw
    // This is where you should place your input FASTQ files
    raw_fastq_dir = { "${params.fastq_dir()}/raw" }

    // =====================================================================================
    // STAR ALIGNMENT PARAMETERS
    // =====================================================================================
    // Arguments passed to STAR aligner
    // See star_align.nf for detailed explanation of each parameter
    
    STAR_ARGS = [        
        // Basic operation mode     
        "--runMode", "alignReads",              // Perform alignment (vs. index generation)
        "--twopassMode", "Basic",               // Enable two-pass mode for novel junction discovery
        "--quantMode", "GeneCounts",            // Generate gene count matrix        
        
        // Splice junction parameters        
        "--sjdbOverhang", "100",                // Max overhang for junctions (ReadLength - 1)        
        
        // Input file handling        
        "--readFilesCommand", "zcat",           // Decompress .gz files on-the-fly        
        
        // Multi-mapping control        
        "--outFilterMultimapNmax", "10",        // Allow reads to map to up to 10 loci        
        
        // Mismatch filtering        
        "--outFilterMismatchNmax", "999",       // Don't filter by total mismatches
        "--outFilterMismatchNoverReadLmax", "0.04",  // Filter by mismatch rate (4% of read length)
        "--outFilterType", "BySJout",           // Filter junctions by confidence        
        
        // Alignment strategy        
        "--alignEndsType", "Local",             // Allow soft-clipping at read ends
        "--alignIntronMin", "20",               // Minimum intron size (gaps <20bp are deletions)
        "--alignIntronMax", "1000000",          // Maximum intron size (1 Mb)
        "--alignMatesGapMax", "1000000",        // Maximum distance between PE mates        
        
        // Output format        
        "--outSAMunmapped", "Within",           // Include unmapped reads in BAM
        "--outSAMtype", "BAM", "SortedByCoordinate"  // Output sorted BAM file
    ]

    // =====================================================================================
    // SALMON QUANTIFICATION PARAMETERS
    // =====================================================================================
    // Arguments passed to SALMON quantifier
    // See salmon_quant.nf for detailed explanation
    
    SALMON_ARGS = [
        "--libType", "A",       // Auto-detect library type (strand orientation)
        "--gcBias",             // Correct for GC content bias
        "--seqBias",            // Correct for sequence-specific bias (hexamer priming)
        "--posBias"             // Correct for positional bias along transcripts
    ]
    
    // =====================================================================================
    // REFERENCE GENOME FILES
    // =====================================================================================
    // Maps for species-specific reference files
    // Each species has its own FASTA and GTF files
    
    // Reference genome FASTA files
    // Used for alignment and indexing
    ref_fasta = [
        Human : "${params.ref_dir}/Human/Homo_sapiens.GRCh38.dna.primary_assembly.fa",
        Mouse : "${params.ref_dir}/Mouse/Mus_musculus.GRCm39.dna.primary_assembly.fa"
    ]

    // Reference genome GTF annotation files
    // Contains gene models, transcript structures, and feature annotations
    ref_gtf = [
        Human : "${params.ref_dir}/Human/Homo_sapiens.GRCh38.113.gtf",
        Mouse : "${params.ref_dir}/Mouse/Mus_musculus.GRCm39.113.gtf"
    ]

    // =====================================================================================
    // MULTIQC REPORT CONFIGURATION
    // =====================================================================================
    // Customize MultiQC report title and filename
    // These also use closures to incorporate project name at runtime
    
    multiqc_titlename = { "${params.project} MultiQC Report" }
    multiqc_filename  = { "${params.project}_MultiQC_Report" }
}

// =========================================================================================
// PROJECT-SPECIFIC PROFILES
// =========================================================================================
// Each profile overrides default parameters for a specific project
// Usage: nextflow run main.nf -profile <profile_name>
//
// To add a new project:
//   1. Copy an existing profile block
//   2. Change the profile name
//   3. Set project, species, and genome_version
//   4. Ensure raw FASTQ files are in: ${base_dir}/RNASeq/${project}/01.FastQ/raw/

profiles {

    // =====================================================================================
    // HUMAN PROJECTS
    // =====================================================================================
    
    manish_arc {
        params.project        = "Manish_22RV1_ARCaPM"
        params.species        = "Human"
        params.genome_version = "GRCh38"
    }
    
    manish_xeno {
        params.project        = "Manish_22RV1_Xenograft"
        params.species        = "Human"
        params.genome_version = "GRCh38"
    }
    
    manish_xeno2 {
        params.project        = "Manish_22RV1_Xenograft2"
        params.species        = "Human"
        params.genome_version = "GRCh38"
    }
    
    vera {
        params.project        = "Vera"
        params.species        = "Human"
        params.genome_version = "GRCh38"
    }
    
    xinyi {
        params.project        = "Xinyi"
        params.species        = "Human"
        params.genome_version = "GRCh38"
    }

    // =====================================================================================
    // MOUSE PROJECTS
    // =====================================================================================
    
    sandrine {
        params.project        = "Sandrine_Quad"
        params.species        = "Mouse"
        params.genome_version = "GRCm39"
    }
    
    supriya {
        params.project        = "Supriya_Quad"
        params.species        = "Mouse"
        params.genome_version = "GRCm39"
    }
    
    // =====================================================================================
    // EXECUTION ENVIRONMENT PROFILES
    // =====================================================================================
    // These can be combined with project profiles
    // Example: nextflow run main.nf -profile xinyi,sge -resume
    //
    // About workDir:
    //   - Stores intermediate files and cached results for -resume functionality
    //   - Can be safely deleted after successful pipeline completion
    //   - Should be on a filesystem with sufficient space
    
    // -------------------------------------------------------------------------------------
    // SGE (Sun Grid Engine) cluster execution
    // -------------------------------------------------------------------------------------
    // Submits each process as an SGE job on HPC clusters
    // Suitable for institutional HPC environments using SGE/Grid Engine
    sge {
        process.executor       = 'sge'                    // Use SGE executor
        process.queue          = 'all.q'                  // SGE queue name
        process.penv           = 'smp'                    // Parallel environment for multi-core jobs
        process.clusterOptions = { "-S /bin/bash -l h_vmem=${task.memory.toGiga()}G" }
        workDir                = "${params.base_dir}/work"
        
        // Throttle job submissions to protect your SGE account from overload
        executor {
            queueSize = 10                                // Max number of jobs in queue at once
        }
    }

    // -------------------------------------------------------------------------------------
    // AWS Batch cloud execution
    // -------------------------------------------------------------------------------------
    // Executes pipeline on AWS Batch for cloud-based computing
    // Requires AWS account setup and appropriate IAM roles
    aws {
        process.executor = 'awsbatch'                     // Use AWS Batch executor
        process.queue    = 'your-job-queue-name'          // Replace with your AWS Batch job queue
        process.memory   = { task.memory.toMega() }       // Convert memory to MB for AWS
        
        // Intermediate files go to the cloud bucket
        workDir = "s3://my-nextflow-bucket/work"          // Replace with your S3 bucket
        
        // AWS-specific configuration
        aws {
            region = 'us-east-1'                          // AWS region
            batch {
                // IAM role for AWS Batch to access S3
                // This is usually required so Batch can talk to S3
                jobRole = 'arn:aws:iam::YOUR_ACCOUNT_ID:role/AmazonBatchServiceRole'
                cliPath = '/home/ec2-user/miniconda/bin/aws'
                
                // Equivalent to submitRateLimit: avoids "RequestLimitExceeded" errors
                maxParallelTransfers = 5
            }
        }
        
        // AWS Batch REQUIRES Docker. You must tell Nextflow to use Docker
        // instead of Singularity when this profile is active.
        docker.enabled      = true
        singularity.enabled = false
    }
}

// =========================================================================================
// PROCESS EXECUTION CONFIGURATION
// =========================================================================================
// Defines resource allocation, error handling, and output directories for all processes
// These settings apply to individual process executions

process {
    
    // =====================================================================================
    // DEFAULT SETTINGS (Applied to ALL processes)
    // =====================================================================================
    
    // Error handling strategy
    // Only retry if exit code indicates memory issues (137, 139, 140, 143)
    // Exit codes:
    //   137 = SIGKILL (out of memory)
    //   139 = SIGSEGV (segmentation fault, often memory-related)
    //   140 = SIGTERM with stack overflow
    //   143 = SIGTERM (terminated, often due to memory)
    // Otherwise, terminate immediately to avoid wasting resources
    errorStrategy = { task.exitStatus in [137, 139, 140, 143] ? 'retry' : 'terminate' }
    
    // Maximum number of retry attempts
    // Each retry doubles the memory allocation (see memory settings below)
    maxRetries = 3
    
    // Default resources (catch-all for processes without specific labels)
    cpus   = 1
    memory = 2.GB

    // =====================================================================================
    // RESOURCE ALLOCATION BY PROCESS TIER
    // =====================================================================================
    // Processes are labeled based on computational requirements
    // Memory scales with task.attempt for automatic retry with more resources
    
    // -------------------------------------------------------------------------------------
    // LOW TIER: Lightweight processes
    // -------------------------------------------------------------------------------------
    // Examples: FastQC, samtools index, file format conversions
    withLabel: 'process_low' {
        cpus   = 2
        memory = { 3.GB * task.attempt }
        // First attempt: 3GB, second: 6GB, third: 9GB, fourth: 12GB
    }

    // -------------------------------------------------------------------------------------
    // MEDIUM TIER: Moderate compute requirements
    // -------------------------------------------------------------------------------------
    // Examples: RSeQC analysis, SALMON quantification
    withLabel: 'process_medium' {
        cpus   = 4
        memory = { 12.GB * task.attempt }
        // First attempt: 12GB, second: 24GB, third: 36GB, fourth: 48GB
    }

    // -------------------------------------------------------------------------------------
    // HIGH TIER: Computationally intensive processes
    // -------------------------------------------------------------------------------------
    // Examples: STAR alignment, reference genome indexing
    withLabel: 'process_high' {
        cpus   = 8
        memory = { 48.GB * task.attempt }
        // First attempt: 48GB, second: 96GB, third: 144GB, fourth: 192GB
    }
    
    // =====================================================================================
    // PROCESS-SPECIFIC CONFIGURATIONS
    // =====================================================================================
    // Each process has custom publishDir settings to organize outputs
    // Multiple publishDir entries allow copying different output types to different locations
    
    // -------------------------------------------------------------------------------------
    // FASTQC: Quality control on FASTQ files
    // -------------------------------------------------------------------------------------
    // Outputs organized by read type (raw/trimmed)
    // NOTE: Closures { } allow dynamic path evaluation based on ${read_type} variable
    //       which is set by the process when it emits outputs
    
    withName: 'FASTQC' {
        container = 'quay.io/biocontainers/fastqc:0.12.1--hdfd78af_0'
        publishDir = [
            // HTML reports for manual inspection
            [
                path: { "${params.proj_dir()}/02.FastQC/${read_type}" },
                mode: 'copy',
                pattern: "*.html"
            ],
            // ZIP files for MultiQC parsing
            [
                path: { "${params.proj_dir()}/02.FastQC/${read_type}" },
                mode: 'copy',
                pattern: "*.zip"
            ],
            // Error logs for debugging
            [
                path: "${params.proj_dir()}/07.Logs/",
                mode: 'copy',
                pattern: "*.FASTQC.error.log"
            ]
        ]
    }

    // -------------------------------------------------------------------------------------
    // PREP_REFERENCE: Index reference genome
    // -------------------------------------------------------------------------------------
    // Indexes are published to reference directory (not project directory)
    // This allows reuse across multiple projects
    
    withName: 'PREP_REFERENCE' {
        container = 'quay.io/biocontainers/star:2.7.11b--h5ca1c30_4'
        publishDir = [
            // STAR index directory
            [
                path: "${params.ref_dir}/${params.species}",
                mode: 'copy',
                pattern: "star_index_dir"
            ],
            // SALMON index directory
            [
                path: "${params.ref_dir}/${params.species}",
                mode: 'copy',
                pattern: "salmon_index_dir"
            ],
            // BED annotation file for RSeQC
            [
                path: "${params.ref_dir}/${params.species}",
                mode: 'copy',
                pattern: "ref_bed"
            ],
            // Error logs
            [
                path: "${params.proj_dir()}/07.Logs/",
                mode: 'copy',
                pattern: "*.PREP_REFERENCE.error.log"
            ]
        ]
    }
    
    // -------------------------------------------------------------------------------------
    // SALMON_QUANT: Transcript quantification
    // -------------------------------------------------------------------------------------
    // Multiple publishDir entries for different organizational needs
    
    withName: 'SALMON_QUANT' {
        container = 'quay.io/biocontainers/salmon:1.10.3--h7e5ed60_0'
        publishDir = [
            // Full SALMON output directory (contains meta_info.json, aux_info/, etc.)
            // Nextflow automatically knows 'sample_id' because it's in the output tuple
            [
                path: "${params.proj_dir()}/03.Salmon/",
                mode: 'copy',
                pattern: { "${sample_id}" }
            ],
            // Just the quant.sf file, renamed for easy collection
            // **/quant.sf searches recursively within subdirectories
            [
                path: "${params.proj_dir()}/03.Salmon/quant_files",
                mode: 'copy',
                pattern: "**/quant.sf",
                saveAs: { filename -> "${sample_id}.quant.sf" }
            ],
            // Error logs
            [
                path: "${params.proj_dir()}/07.Logs/",
                mode: 'copy',
                pattern: "*.SALMON_QUANT.error.log"
            ]
        ]
    }

    // -------------------------------------------------------------------------------------
    // STAR_ALIGN: Genome alignment
    // -------------------------------------------------------------------------------------
    // Multiple output files: BAM, BAI, gene counts, splice junctions, alignment stats
    
    withName: 'STAR_ALIGN' {
        container = 'quay.io/biocontainers/star:2.7.11b--h5ca1c30_4'
        publishDir = [
            // Aligned BAM file
            [
                path: "${params.proj_dir()}/04.STAR/",
                mode: 'copy',
                pattern: "*.bam"
            ],
            // BAM index (.bai)
            [
                path: "${params.proj_dir()}/04.STAR/",
                mode: 'copy',
                pattern: "*.bai"
            ],
            // Gene count matrix
            [
                path: "${params.proj_dir()}/04.STAR/",
                mode: 'copy',
                pattern: "*.ReadsPerGene.out.tab"
            ],
            // Splice junction table
            [
                path: "${params.proj_dir()}/04.STAR/",
                mode: 'copy',
                pattern: "*.SJ.out.tab"
            ],
            // Alignment statistics
            [
                path: "${params.proj_dir()}/04.STAR/",
                mode: 'copy',
                pattern: "*.Log.final.out"
            ],
            // Error logs
            [
                path: "${params.proj_dir()}/07.Logs/",
                mode: 'copy',
                pattern: "*.STAR.error.log"
            ]
        ]
    }
    
    // -------------------------------------------------------------------------------------
    // RSEQC: Alignment quality control
    // -------------------------------------------------------------------------------------
    // Generates plots (PDF, JPEG, PNG) and data files (TXT, LOG, R)
    
    withName: 'RSEQC' {
        container = 'quay.io/biocontainers/rseqc:5.0.4--py39h0db74d2_0'
        publishDir = [
            // Plot files for visualization
            [
                path: "${params.proj_dir()}/05.RSeQC/",
                mode: 'copy',
                pattern: "*.{pdf,jpeg,png,tiff}"
            ],
            // Data files for MultiQC and custom analysis
            [
                path: "${params.proj_dir()}/05.RSeQC/",
                mode: 'copy',
                pattern: "*.{txt,log,r}"
            ],
            // Error logs
            [
                path: "${params.proj_dir()}/07.Logs/",
                mode: 'copy',
                pattern: "*.RSEQC.error.log"
            ]
        ]
    }
    
    // -------------------------------------------------------------------------------------
    // MULTIQC: Aggregate QC reports
    // -------------------------------------------------------------------------------------
    // Combines all QC outputs into a single HTML report
    
    withName: 'MULTIQC' {
        container = 'quay.io/biocontainers/multiqc:1.33--pyhdfd78af_0'
        publishDir = [
            // Main HTML report
            [
                path: "${params.proj_dir()}/06.MultiQC/",
                mode: 'copy',
                pattern: "*.html"
            ],
            // Data directory (contains JSON, CSV files)
            [
                path: "${params.proj_dir()}/06.MultiQC/",
                mode: 'copy',
                pattern: "*_data"
            ],
            // Error logs
            [
                path: "${params.proj_dir()}/07.Logs/",
                mode: 'copy',
                pattern: "MULTIQC.error.log"
            ]
        ]
    }
}

// =========================================================================================
// NEXTFLOW WORK DIRECTORY STRUCTURE
// =========================================================================================
// The work directory contains all intermediate files and task execution details
// Understanding this structure is crucial for debugging and troubleshooting
//
// work/
// ├── 12/
// │   └── 3a4b5c.../                    # Unique hash for each task
// │       ├── .command.sh               # Executed script
// │       ├── .command.log              # stdout/stderr
// │       ├── .command.begin            # Timestamp
// │       ├── .command.run              # Execution wrapper
// │       └── [output files]            # Task outputs (symlinked to publishDir)
// └── [more task directories]
//
// Each task gets a unique directory identified by a hash
// Files are staged in this directory, then published to final locations via publishDir
// Successful tasks are cached, allowing -resume to skip completed work

// =========================================================================================
// CONFIGURATION NOTES AND BEST PRACTICES
// =========================================================================================
//
// 1. ADDING NEW PROJECTS:
//    - Add a new profile block with project-specific parameters
//    - Ensure FASTQ files follow naming conventions (see VALIDATE_INPUT process)
//    - Verify reference genome files exist for the species
//
// 2. RESOURCE TUNING:
//    - Adjust memory multipliers based on your data size
//    - Monitor resource usage with timeline.html report
//    - Increase maxRetries if jobs frequently fail due to memory
//
// 3. PUBLISHDIR MODES:
//    - 'copy': Copies files (safe, uses more space)
//    - 'symlink': Creates symbolic links (saves space, but fragile)
//    - 'move': Moves files (fastest, but removes from work/)
//    We use 'copy' for reliability and data preservation
//
// 4. PROFILE COMBINATIONS:
//    - Combine multiple profiles: -profile xinyi,sge -resume
//    - Order doesn't matter for non-conflicting settings
//    - Later profiles override earlier ones for conflicting settings
//
// 5. TESTING CHANGES:
//    - Test with a small dataset first
//    - Use -with-dag to visualize workflow
//    - Check trace.txt for resource usage
//
// 6. CLEANUP STRATEGY:
//    - Keep work/ during development (enables -resume)
//    - Remove work/ after successful production runs (nextflow clean -f)
//    - Archive important outputs before cleaning
//
// 7. TROUBLESHOOTING:
//    - Check .nextflow.log for parsing errors
//    - Review task-specific logs in work/xx/yyyy.../.command.log
//    - Use -with-trace -with-timeline for resource insights
//
// =========================================================================================
// END OF CONFIGURATION
// =========================================================================================