// =========================================================================================
// PROCESS: FASTQC
// =========================================================================================
// Purpose: Performs quality control analysis on FASTQ files using FastQC
//
// FastQC generates:
//   - HTML reports with quality metrics and plots
//   - ZIP files containing raw data for MultiQC aggregation
//
// Quality metrics include:
//   - Per-base sequence quality
//   - Per-sequence quality scores
//   - Per-base sequence content
//   - GC content distribution
//   - Sequence length distribution
//   - Sequence duplication levels
//   - Overrepresented sequences
//   - Adapter content
//
// This process is called twice in the workflow:
//   1. FASTQC_RAW - for raw input reads
//   2. FASTQC_TRIMMED - for trimmed reads (if trimming is performed)
// =========================================================================================

process FASTQC {
	
	tag "FastQC on ${sample_id} (${read_type})"  // Display tag in workflow logs
    label 'process_low'  // Resource allocation: FastQC doesn't need lots of RAM
		
	// =================================================================================
	// INPUT
	// =================================================================================
	// tuple: [sample_id, fastq_files, read_type]
	//   - sample_id: Unique identifier for the sample (String)
	//   - fastq_files: List of FASTQ file paths (1 for SE, 2 for PE)
	//   - read_type: "raw" or "trimmed" - used for output directory organization
	input:
	tuple val(sample_id), path(fastq_files), val(read_type)
	
	// =================================================================================
	// OUTPUT
	// =================================================================================
	// FastQC generates one ZIP and one HTML per input FASTQ file
	// For PE data: 2 ZIPs + 2 HTMLs (one for R1, one for R2)
	// For SE data: 1 ZIP + 1 HTML
	output:
	path("*_fastqc.zip"),			emit: fastqc_zip        // Machine-readable results for MultiQC
	path("*_fastqc.html"),			emit: fastqc_html       // Human-readable HTML reports
	path("*.FASTQC.error.log"),		emit: fastqc_error_log  // Error/success log for debugging
	
	// =================================================================================
	// SCRIPT
	// =================================================================================
	script:
	
	// Construct log filename: SampleID.ReadType.ProcessName.error.log
	// Example: "Sample1.raw.FASTQC.error.log"
	def LOG = "${sample_id}.${read_type}.FASTQC.error.log"
	
	"""
	# =============================================================================
	# Run FastQC quality control analysis
	# =============================================================================
	# FastQC analyzes sequence quality and generates comprehensive QC reports
	# 
	# Parameters:
	#   --threads: Number of CPU cores to use (from Nextflow task.cpus)
	#   --quiet: Suppress progress messages (only show errors/warnings)
	#   ${fastq_files.join(' ')}: Space-separated list of input FASTQ files
	#
	# Output files (auto-generated by FastQC):
	#   - *_fastqc.html: Interactive HTML report with plots and tables
	#   - *_fastqc.zip: Compressed data files (used by MultiQC)
	# =============================================================================
	
	fastqc \
		--threads "${task.cpus}" \
		--quiet \
		${fastq_files.join(' ')}
		1>> "${LOG}" 2>&1 \
		|| { echo "? ERROR: FastQC failed for ${sample_id}" | tee -a "${LOG}" >&2; exit 1; }	
	
	# Log success message
	echo "? SUCCESS: FastQC completed for ${sample_id}" >> "${LOG}"
	
	"""
}

// =========================================================================================
// TECHNICAL NOTES
// =========================================================================================
// 
// 1. WHY TWO CALLS IN WORKFLOW?
//    - FASTQC_RAW: Assess raw data quality to detect sequencing issues
//    - FASTQC_TRIMMED: Verify trimming improved quality (if applicable)
//
// 2. FASTQ FILE HANDLING:
//    - ${fastq_files.join(' ')} converts the list to a space-separated string
//    - Example SE: "Sample1_R1.fq.gz"
//    - Example PE: "Sample1_R1.fq.gz Sample1_R2.fq.gz"
//
// 3. ERROR HANDLING:
//    - || captures non-zero exit codes from FastQC
//    - { ... } block executes on failure: logs error and exits with code 1
//    - tee -a: Writes to both log file AND stderr (visible in Nextflow logs)
//
// 4. OUTPUT PUBLISHING:
//    - Configured in nextflow.config using closures
//    - ${read_type} allows dynamic directory names (raw/ or trimmed/)
//    - publishDir uses 'copy' mode to preserve files after workflow completion
//
// 5. MULTIQC INTEGRATION:
//    - The ZIP files contain machine-readable data
//    - MultiQC parses these ZIPs to create aggregate reports
//    - HTML files are for manual inspection
// ========================================================================================='